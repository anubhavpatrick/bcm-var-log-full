# =============================================================================
# bcm-recovery.conf — Configuration for BCM Head Node Recovery Script
# =============================================================================
# Related Incident: INC-2025-0210
# Source this file from bcm-recovery.sh. All paths must be absolute.
# =============================================================================

# -----------------------------------------------------------------------------
# Backup settings
# -----------------------------------------------------------------------------
# Project root on the head node (root / partition — 5.8TB at 3% utilization).
PROJECT_DIR="/root/bcm-var-log-full"

# Base directory for config file backups (pre-recovery and post-recovery).
# Each run creates a timestamped subdirectory under this path.
# This directory is small (a few KB) and safe to share with support.
BACKUP_BASE_DIR="${PROJECT_DIR}/backups"

# Separate directory for the large syslog incident backup (~173GB).
# Kept outside backups/ so it is not accidentally bundled when sharing
# config backups or monitoring reports with support.
SYSLOG_BACKUP_DIR="${PROJECT_DIR}/syslog-backup"

# Minimum free space (GB) required on the syslog backup partition before
# the script will proceed. The syslog file alone is ~173GB.
REQUIRED_FREE_SPACE_GB=180

# Suffix appended to config file backups (e.g., rsyslog.pre-recovery)
CONFIG_BACKUP_SUFFIX=".pre-recovery"
CONFIG_POST_SUFFIX=".post-recovery"

# -----------------------------------------------------------------------------
# Lock file — prevents multiple instances from running simultaneously.
# Uses /tmp/ instead of /var/lock/ because /var may be full.
# -----------------------------------------------------------------------------
LOCK_FILE="/tmp/bcm-recovery.lock"

# -----------------------------------------------------------------------------
# Logging
# -----------------------------------------------------------------------------
# Day-stamped log directory — one log file per day.
# e.g., logs/2025-02-11/bcm-recovery.log
LOG_DIR="${PROJECT_DIR}/logs"

# -----------------------------------------------------------------------------
# Disk settings
# -----------------------------------------------------------------------------
VAR_MOUNT_POINT="/var"

# If /var usage is BELOW this threshold, the script will warn and prompt
# whether to continue (recovery may not be needed).
VAR_WARN_THRESHOLD=80

# -----------------------------------------------------------------------------
# Target files
# -----------------------------------------------------------------------------
SYSLOG_FILE="/var/log/syslog"
CMDAEMON_SPOOL="/var/spool/cmd"

# Maximum acceptable syslog size (bytes) after truncation.
# rsyslog keeps writing via its open file descriptor, so the file will not
# stay at exactly 0 bytes.  50 MB gives ample headroom.
TRUNCATE_MAX_BYTES=$((50 * 1024 * 1024))

# -----------------------------------------------------------------------------
# Configuration files to modify
# -----------------------------------------------------------------------------
LOGROTATE_RSYSLOG_CONF="/etc/logrotate.d/rsyslog"
RSYSLOG_CONF="/etc/rsyslog.conf"

# -----------------------------------------------------------------------------
# Service names (systemd units)
# -----------------------------------------------------------------------------
CMD_SERVICE="cmd.service"
RSYSLOG_SERVICE="rsyslog"
POSTFIX_SERVICE="postfix"

# -----------------------------------------------------------------------------
# CMDaemon / cmsh verification
# -----------------------------------------------------------------------------
CMSH_COMMAND="cmsh"
CMSH_TEST_COMMAND="device status"
CMSH_TIMEOUT=30

# -----------------------------------------------------------------------------
# Service restart behavior
# -----------------------------------------------------------------------------
MAX_SERVICE_RESTART_RETRIES=3
SERVICE_RESTART_DELAY=5
SERVICE_RESTART_TIMEOUT=120

# -----------------------------------------------------------------------------
# rsyslog rate limiting (appended to /etc/rsyslog.conf)
# Prevents error loops from generating unbounded log volume.
# -----------------------------------------------------------------------------
RSYSLOG_RATE_LIMIT_INTERVAL=5
RSYSLOG_RATE_LIMIT_BURST=5000

# -----------------------------------------------------------------------------
# New logrotate configuration
# Written to /etc/logrotate.d/rsyslog during Phase 3.
# Key changes from original: weekly→daily, added maxsize, added postrotate.
# Worst-case syslog disk usage: 5 × 5GB = 25GB (was unbounded).
# -----------------------------------------------------------------------------
read -r -d '' LOGROTATE_CONFIG << 'LOGROTATE_EOF' || true
/var/log/syslog
{
        su root syslog
        rotate 5
        daily
        maxsize 5G
        missingok
        notifempty
        compress
        delaycompress
        postrotate
                /usr/lib/rsyslog/rsyslog-rotate
        endscript
}

/var/log/mail.log
/var/log/kern.log
/var/log/auth.log
/var/log/user.log
/var/log/cron.log
{
        su root syslog
        rotate 4
        daily
        maxsize 500M
        missingok
        notifempty
        compress
        delaycompress
        sharedscripts
        postrotate
                /usr/lib/rsyslog/rsyslog-rotate
        endscript
}
LOGROTATE_EOF
